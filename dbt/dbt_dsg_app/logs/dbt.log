[0m16:02:08.693305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff9446f8b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff933bfc70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff933bfd00>]}


============================== 16:02:08.700437 | 8219def9-7534-47fd-a4cd-644f40000276 ==============================
[0m16:02:08.700437 [info ] [MainThread]: Running with dbt=1.5.6
[0m16:02:08.703837 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/opt/airflow/dbt/dbt_dsg_app', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/opt/airflow/dbt/dbt_dsg_app/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True'}
[0m16:02:09.156317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff9416c910>]}
[0m16:02:09.167017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7bb27fd0>]}
[0m16:02:09.169386 [info ] [MainThread]: Registered adapter: snowflake=1.5.2
[0m16:02:09.178894 [debug] [MainThread]: checksum: 3566a71ed44933faac09a52986b43ce852c449f14acfdb53b69c0c788f4e1e66, vars: {'env': 'dev'}, profile: , target: dev, version: 1.5.6
[0m16:02:09.185324 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m16:02:09.188199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7bac0310>]}
[0m16:02:09.551309 [debug] [MainThread]: 1699: static parser successfully parsed global/fact_ip_to_company_domain.sql
[0m16:02:09.561894 [debug] [MainThread]: 1699: static parser successfully parsed ipflow/src_ipflow_ip_to_location.sql
[0m16:02:09.566708 [debug] [MainThread]: 1699: static parser successfully parsed ipflow/src_ipflow_merge_domain_observations.sql
[0m16:02:09.571340 [debug] [MainThread]: 1603: static parser failed on ipflow/src_ipflow_merge_output.sql
[0m16:02:09.576519 [debug] [MainThread]: 1602: parser fallback to jinja rendering on ipflow/src_ipflow_merge_output.sql
[0m16:02:09.580341 [debug] [MainThread]: 1699: static parser successfully parsed ipflow/src_ipflow_merge_success_output.sql
[0m16:02:09.584592 [debug] [MainThread]: 1699: static parser successfully parsed ipflow/src_ipflow_normalized_location.sql
[0m16:02:09.592481 [debug] [MainThread]: 1699: static parser successfully parsed ipflow/stg_ipflow_input_data.sql
[0m16:02:09.596301 [debug] [MainThread]: 1603: static parser failed on ipflow/stg_ipflow_ip_to_location_mappings.sql
[0m16:02:09.604885 [debug] [MainThread]: 1602: parser fallback to jinja rendering on ipflow/stg_ipflow_ip_to_location_mappings.sql
[0m16:02:09.607628 [debug] [MainThread]: 1603: static parser failed on ipflow/stg_ipflow_merge_domain_observations.sql
[0m16:02:09.612843 [debug] [MainThread]: 1602: parser fallback to jinja rendering on ipflow/stg_ipflow_merge_domain_observations.sql
[0m16:02:09.616046 [debug] [MainThread]: 1603: static parser failed on ipflow/stg_ipflow_merge_output.sql
[0m16:02:09.621011 [debug] [MainThread]: 1602: parser fallback to jinja rendering on ipflow/stg_ipflow_merge_output.sql
[0m16:02:09.625312 [debug] [MainThread]: 1603: static parser failed on ipflow/stg_ipflow_merge_success_output.sql
[0m16:02:09.631235 [debug] [MainThread]: 1602: parser fallback to jinja rendering on ipflow/stg_ipflow_merge_success_output.sql
[0m16:02:09.634427 [debug] [MainThread]: 1699: static parser successfully parsed ipflow/stg_ipflow_success_data.sql
[0m16:02:09.711173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7a5130d0>]}
[0m16:02:09.753274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7a496130>]}
[0m16:02:09.756810 [info ] [MainThread]: Found 12 models, 2 tests, 0 snapshots, 0 analyses, 322 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics, 0 groups
[0m16:02:09.759019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7a4b1730>]}
[0m16:02:09.761898 [info ] [MainThread]: 
[0m16:02:09.764933 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:02:09.768392 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_DEV_DB'
[0m16:02:09.779647 [debug] [ThreadPool]: Using snowflake connection "list_DEV_DB"
[0m16:02:09.782100 [debug] [ThreadPool]: On list_DEV_DB: /* {"app": "dbt", "dbt_version": "1.5.6", "profile_name": "dbt_dsg_app", "target_name": "dev", "connection_name": "list_DEV_DB"} */
show terse schemas in database DEV_DB
    limit 10000
[0m16:02:09.784161 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:02:10.421661 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 1.0 seconds
[0m16:02:10.427789 [debug] [ThreadPool]: On list_DEV_DB: Close
[0m16:02:10.623518 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_DEV_DB, now list_DEV_DB_CONTACT_COMPANY)
[0m16:02:10.636968 [debug] [ThreadPool]: Using snowflake connection "list_DEV_DB_CONTACT_COMPANY"
[0m16:02:10.641350 [debug] [ThreadPool]: On list_DEV_DB_CONTACT_COMPANY: /* {"app": "dbt", "dbt_version": "1.5.6", "profile_name": "dbt_dsg_app", "target_name": "dev", "connection_name": "list_DEV_DB_CONTACT_COMPANY"} */
show terse objects in DEV_DB.CONTACT_COMPANY
[0m16:02:10.645764 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:02:11.602806 [debug] [ThreadPool]: SQL status: SUCCESS 28 in 1.0 seconds
[0m16:02:11.608306 [debug] [ThreadPool]: On list_DEV_DB_CONTACT_COMPANY: Close
[0m16:02:11.810283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7babdb20>]}
[0m16:02:11.815234 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m16:02:11.818200 [info ] [MainThread]: 
[0m16:02:11.832745 [debug] [Thread-1  ]: Began running node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:02:11.835564 [info ] [Thread-1  ]: 1 of 1 START sql table model CONTACT_COMPANY.stg_ipflow_input_data ............. [RUN]
[0m16:02:11.838384 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_DEV_DB_CONTACT_COMPANY, now model.dbt_dsg_app.stg_ipflow_input_data)
[0m16:02:11.840879 [debug] [Thread-1  ]: Began compiling node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:02:11.850174 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_dsg_app.stg_ipflow_input_data"
[0m16:02:11.892484 [debug] [Thread-1  ]: Timing info for model.dbt_dsg_app.stg_ipflow_input_data (compile): 16:02:11.847296 => 16:02:11.892146
[0m16:02:11.894553 [debug] [Thread-1  ]: Began executing node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:02:11.925571 [debug] [Thread-1  ]: Writing runtime sql for node "model.dbt_dsg_app.stg_ipflow_input_data"
[0m16:02:11.969363 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_dsg_app.stg_ipflow_input_data"
[0m16:02:11.973255 [debug] [Thread-1  ]: On model.dbt_dsg_app.stg_ipflow_input_data: /* {"app": "dbt", "dbt_version": "1.5.6", "profile_name": "dbt_dsg_app", "target_name": "dev", "node_id": "model.dbt_dsg_app.stg_ipflow_input_data"} */
create or replace transient table DEV_DB.CONTACT_COMPANY.stg_ipflow_input_data
         as
        (

with mapped_ips as (
select  DISTINCT BD.USER_IP 
 
FROM DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY AS BD 
INNER JOIN FIVE_BY_FIVE_DEMO.PRODUCTS.IP_COMPANY_2_11_0 AS FBF 
ON IP_ADDRESS =  USER_IP

UNION 

select  DISTINCT BD.USER_IP 
FROM DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY AS BD 
INNER JOIN DEV_IP_FLOW.STAGING.IP_FLOW_API_OUTPUT_DATA AS IPF 
ON BD.USER_IP =  IPF.USER_IP
WHERE IPF.LAST_RESPONSE_CODE = 200
)
, unmapped_ips as (
select DISTINCT BD.USER_IP 
FROM DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY AS BD 
where BD.USER_IP not in (select user_ip from mapped_ips)
) ,
unmapped_ips_frequency as (
select a.USER_IP, count(b.PAGE_URL) as frequency from unmapped_ips as a 
left join DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY b 
on a.USER_IP = b.USER_IP
group by a.USER_IP
),
unmapped_ips_ranked as (
select a.*, row_number() over (order by frequency desc) as row_number_ranked
  from unmapped_ips_frequency as a
),
unmapped_ips_zero_deprioritized as (
select USER_IP from unmapped_ips_ranked where SPLIT_PART(USER_IP, '.', 4) <> 0
union
select USER_IP from unmapped_ips_ranked where SPLIT_PART(USER_IP, '.', 4) = 0 
)
select USER_IP from unmapped_ips_zero_deprioritized a
where not exists  
( select null from DEV_IP_FLOW.STAGING.IP_FLOW_API_OUTPUT_DATA as b  
where a.USER_IP = b.USER_IP   
and ( b.LAST_QUERY_DATE >= DATE( DATEADD(day, -30, GETDATE()) ) 
and b.LAST_RESPONSE_CODE = 204 )  )
limit 1
        );
[0m16:02:11.975779 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:02:14.058818 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 2.0 seconds
[0m16:02:14.079035 [debug] [Thread-1  ]: Timing info for model.dbt_dsg_app.stg_ipflow_input_data (execute): 16:02:11.898749 => 16:02:14.078906
[0m16:02:14.081862 [debug] [Thread-1  ]: On model.dbt_dsg_app.stg_ipflow_input_data: Close
[0m16:02:14.267010 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8219def9-7534-47fd-a4cd-644f40000276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff798540d0>]}
[0m16:02:14.272743 [info ] [Thread-1  ]: 1 of 1 OK created sql table model CONTACT_COMPANY.stg_ipflow_input_data ........ [[32mSUCCESS 1[0m in 2.43s]
[0m16:02:14.277234 [debug] [Thread-1  ]: Finished running node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:02:14.282231 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:02:14.285277 [debug] [MainThread]: Connection 'model.dbt_dsg_app.stg_ipflow_input_data' was properly closed.
[0m16:02:14.287896 [info ] [MainThread]: 
[0m16:02:14.291105 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.52 seconds (4.52s).
[0m16:02:14.293839 [debug] [MainThread]: Command end result
[0m16:02:14.329745 [info ] [MainThread]: 
[0m16:02:14.335749 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:02:14.338981 [info ] [MainThread]: 
[0m16:02:14.341833 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:02:14.346118 [debug] [MainThread]: Command `dbt run` succeeded at 16:02:14.345993 after 5.69 seconds
[0m16:02:14.348325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff9446f8b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7a4990d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7a4f7e80>]}
[0m16:02:14.351302 [debug] [MainThread]: Flushing usage events
[0m16:09:59.502681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7fdf8130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7ed49c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7ed49d00>]}


============================== 16:09:59.510074 | 88849395-0f20-4b63-bbca-65e3b1d02e6b ==============================
[0m16:09:59.510074 [info ] [MainThread]: Running with dbt=1.5.6
[0m16:09:59.513025 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/opt/airflow/dbt/dbt_dsg_app', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/opt/airflow/dbt/dbt_dsg_app/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'send_anonymous_usage_stats': 'True'}
[0m16:09:59.958584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6d6b5c70>]}
[0m16:09:59.973753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6d686fa0>]}
[0m16:09:59.977163 [info ] [MainThread]: Registered adapter: snowflake=1.5.2
[0m16:09:59.989212 [debug] [MainThread]: checksum: 3566a71ed44933faac09a52986b43ce852c449f14acfdb53b69c0c788f4e1e66, vars: {'env': 'dev'}, profile: , target: dev, version: 1.5.6
[0m16:10:00.083567 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:10:00.086242 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:10:00.092269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c8f60d0>]}
[0m16:10:00.134163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c9baac0>]}
[0m16:10:00.143206 [info ] [MainThread]: Found 12 models, 2 tests, 0 snapshots, 0 analyses, 322 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics, 0 groups
[0m16:10:00.145792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c9baa60>]}
[0m16:10:00.150104 [info ] [MainThread]: 
[0m16:10:00.154812 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:10:00.159368 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_DEV_DB'
[0m16:10:00.174984 [debug] [ThreadPool]: Using snowflake connection "list_DEV_DB"
[0m16:10:00.179683 [debug] [ThreadPool]: On list_DEV_DB: /* {"app": "dbt", "dbt_version": "1.5.6", "profile_name": "dbt_dsg_app", "target_name": "dev", "connection_name": "list_DEV_DB"} */
show terse schemas in database DEV_DB
    limit 10000
[0m16:10:00.182501 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:10:00.826941 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 1.0 seconds
[0m16:10:00.831554 [debug] [ThreadPool]: On list_DEV_DB: Close
[0m16:10:01.006645 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_DEV_DB, now list_DEV_DB_CONTACT_COMPANY)
[0m16:10:01.016974 [debug] [ThreadPool]: Using snowflake connection "list_DEV_DB_CONTACT_COMPANY"
[0m16:10:01.019729 [debug] [ThreadPool]: On list_DEV_DB_CONTACT_COMPANY: /* {"app": "dbt", "dbt_version": "1.5.6", "profile_name": "dbt_dsg_app", "target_name": "dev", "connection_name": "list_DEV_DB_CONTACT_COMPANY"} */
show terse objects in DEV_DB.CONTACT_COMPANY
[0m16:10:01.022654 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:10:01.425301 [debug] [ThreadPool]: SQL status: SUCCESS 29 in 0.0 seconds
[0m16:10:01.433284 [debug] [ThreadPool]: On list_DEV_DB_CONTACT_COMPANY: Close
[0m16:10:01.620399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c9ba7f0>]}
[0m16:10:01.625068 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m16:10:01.629265 [info ] [MainThread]: 
[0m16:10:01.645387 [debug] [Thread-1  ]: Began running node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:10:01.648547 [info ] [Thread-1  ]: 1 of 1 START sql table model CONTACT_COMPANY.stg_ipflow_input_data ............. [RUN]
[0m16:10:01.652095 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_DEV_DB_CONTACT_COMPANY, now model.dbt_dsg_app.stg_ipflow_input_data)
[0m16:10:01.654786 [debug] [Thread-1  ]: Began compiling node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:10:01.660213 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_dsg_app.stg_ipflow_input_data"
[0m16:10:01.674166 [debug] [Thread-1  ]: Timing info for model.dbt_dsg_app.stg_ipflow_input_data (compile): 16:10:01.657701 => 16:10:01.673369
[0m16:10:01.676290 [debug] [Thread-1  ]: Began executing node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:10:01.700158 [debug] [Thread-1  ]: Writing runtime sql for node "model.dbt_dsg_app.stg_ipflow_input_data"
[0m16:10:01.712711 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_dsg_app.stg_ipflow_input_data"
[0m16:10:01.716858 [debug] [Thread-1  ]: On model.dbt_dsg_app.stg_ipflow_input_data: /* {"app": "dbt", "dbt_version": "1.5.6", "profile_name": "dbt_dsg_app", "target_name": "dev", "node_id": "model.dbt_dsg_app.stg_ipflow_input_data"} */
create or replace transient table DEV_DB.CONTACT_COMPANY.stg_ipflow_input_data
         as
        (

with mapped_ips as (
select  DISTINCT BD.USER_IP 
 
FROM DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY AS BD 
INNER JOIN FIVE_BY_FIVE_DEMO.PRODUCTS.IP_COMPANY_2_11_0 AS FBF 
ON IP_ADDRESS =  USER_IP

UNION 

select  DISTINCT BD.USER_IP 
FROM DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY AS BD 
INNER JOIN DEV_IP_FLOW.STAGING.IP_FLOW_API_OUTPUT_DATA AS IPF 
ON BD.USER_IP =  IPF.USER_IP
WHERE IPF.LAST_RESPONSE_CODE = 200
)
, unmapped_ips as (
select DISTINCT BD.USER_IP 
FROM DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY AS BD 
where BD.USER_IP not in (select user_ip from mapped_ips)
) ,
unmapped_ips_frequency as (
select a.USER_IP, count(b.PAGE_URL) as frequency from unmapped_ips as a 
left join DEV_BIDSTREAM.ACTIVITY.USER_ACTIVITY b 
on a.USER_IP = b.USER_IP
group by a.USER_IP
),
unmapped_ips_ranked as (
select a.*, row_number() over (order by frequency desc) as row_number_ranked
  from unmapped_ips_frequency as a
),
unmapped_ips_zero_deprioritized as (
select USER_IP from unmapped_ips_ranked where SPLIT_PART(USER_IP, '.', 4) <> 0
union
select USER_IP from unmapped_ips_ranked where SPLIT_PART(USER_IP, '.', 4) = 0 
)
select USER_IP from unmapped_ips_zero_deprioritized a
where not exists  
( select null from DEV_IP_FLOW.STAGING.IP_FLOW_API_OUTPUT_DATA as b  
where a.USER_IP = b.USER_IP   
and ( b.LAST_QUERY_DATE >= DATE( DATEADD(day, -30, GETDATE()) ) 
and b.LAST_RESPONSE_CODE = 204 )  )
limit 1
        );
[0m16:10:01.724766 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:10:03.775587 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 2.0 seconds
[0m16:10:03.795240 [debug] [Thread-1  ]: Timing info for model.dbt_dsg_app.stg_ipflow_input_data (execute): 16:10:01.679609 => 16:10:03.795057
[0m16:10:03.801602 [debug] [Thread-1  ]: On model.dbt_dsg_app.stg_ipflow_input_data: Close
[0m16:10:03.981779 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88849395-0f20-4b63-bbca-65e3b1d02e6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c21a4c0>]}
[0m16:10:03.985245 [info ] [Thread-1  ]: 1 of 1 OK created sql table model CONTACT_COMPANY.stg_ipflow_input_data ........ [[32mSUCCESS 1[0m in 2.33s]
[0m16:10:03.991991 [debug] [Thread-1  ]: Finished running node model.dbt_dsg_app.stg_ipflow_input_data
[0m16:10:03.996170 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:10:03.998121 [debug] [MainThread]: Connection 'model.dbt_dsg_app.stg_ipflow_input_data' was properly closed.
[0m16:10:04.000233 [info ] [MainThread]: 
[0m16:10:04.004247 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.85 seconds (3.85s).
[0m16:10:04.006683 [debug] [MainThread]: Command end result
[0m16:10:04.040612 [info ] [MainThread]: 
[0m16:10:04.045018 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:10:04.048055 [info ] [MainThread]: 
[0m16:10:04.051128 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:10:04.055178 [debug] [MainThread]: Command `dbt run` succeeded at 16:10:04.054997 after 4.58 seconds
[0m16:10:04.057670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff7fdf8130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c7cbee0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0xffff6c93dd00>]}
[0m16:10:04.060418 [debug] [MainThread]: Flushing usage events
